default_platform(:android)

platform :android do
  lane :firebase_release do
    gradle(
      task: "assemble",
      build_type: "Release",
      print_command: true
    )

    # Prefer the path set by the gradle action, then fall back to a glob
    apk = Actions.lane_context[SharedValues::GRADLE_APK_OUTPUT_PATH]
    apk ||= ENV["GRADLE_APK_OUTPUT_PATH"]
    apk ||= Dir["app/build/outputs/apk/release/*.apk"].max_by { |f| File.mtime(f) }

    UI.user_error!("No APK artifact found") unless apk && File.exist?(apk)

    sh("ls -la app/build/outputs/apk/release || true")
    UI.message("Using APK: #{apk}")

    firebase_app_distribution(
      app: ENV["FIREBASE_ANDROID_APP_ID"],
      testers: ENV["FIREBASE_TESTERS"],
      groups: ENV["FIREBASE_GROUPS"],
      release_notes: (ENV["RELEASE_NOTES"] || ""),
      firebase_cli_token: ENV["FIREBASE_TOKEN"],
      apk_path: apk
    )
  end
end
