default_platform(:android)

platform :android do
  lane :firebase_release do
    # Build APK (not AAB)
    gradle(
      task: "assemble",
      build_type: "Release"
    )

    # Pick newest APK
    apk = Dir["app/build/outputs/apk/release/*.apk"].max_by { |f| File.mtime(f) }
    UI.user_error!("No APK artifact found") unless apk

    firebase_app_distribution(
      app: ENV["FIREBASE_ANDROID_APP_ID"],
      testers: ENV["FIREBASE_TESTERS"],
      groups: ENV["FIREBASE_GROUPS"],
      release_notes: (ENV["RELEASE_NOTES"] || ""),
      firebase_cli_token: ENV["FIREBASE_TOKEN"],
      apk_path: apk
    )
  end
end
