default_platform(:ios)

platform :ios do
  desc "Build and upload to Firebase"
  lane :firebase_release do
    # Write signing files from env (generated in CI)
    keychain = "login.keychain"
    create_keychain(name: keychain, password: "", default_keychain: true, unlock: true, timeout: 3600)

    cert_path = File.expand_path("../certs.p12", __dir__)
    File.binwrite(cert_path, Base64.decode64(ENV["IOS_CERTS_P12_BASE64"]))
    import_certificate(
      certificate_path: cert_path,
      certificate_password: ENV["IOS_CERTS_PASSWORD"],
      keychain_name: keychain
    )

    profile_path = File.expand_path("../profile.mobileprovision", __dir__)
    File.binwrite(profile_path, Base64.decode64(ENV["IOS_PROVISIONING_PROFILE_BASE64"]))
    ENV["sigh_profile_path"] = profile_path

    # Build (scheme & workspace must match your RN iOS project)
    gym(
      workspace: "HARMANLIIKENNEOY.xcworkspace",
      scheme: "HARMANLIIKENNEOY",
      configuration: "Release",
      export_method: "ad-hoc", # or "development" for internal testing
      silent: true
    )

    ipa = Dir["./*.ipa"].first
    firebase_app_distribution(
      app: ENV["FIREBASE_IOS_APP_ID"],           # e.g. 1:1234567890:ios:abcdef...
      testers: ENV["FIREBASE_TESTERS"],
      release_notes: ENV["RELEASE_NOTES"] || "",
      groups: ENV["FIREBASE_GROUPS"],
      firebase_cli_token: ENV["FIREBASE_TOKEN"],
      ipa_path: ipa
    )
  end
end
